<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>v8: V8 Sandbox - Readme</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="v8.svg"/></td>
  <td id="projectalign">
   <div id="projectname">v8
   </div>
   <div id="projectbrief">V8 is Googleâ€™s open source high-performance JavaScript and WebAssembly engine, written in C++. It is used in Chrome and in Node.js, among others. It implements ECMAScript and WebAssembly, and runs on Windows, macOS, and Linux systems that use x64, IA-32, or ARM processors. V8 can be embedded into any C++ application.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',true);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){initNavTree('md_src_2sandbox_2README.html',''); initResizable(true); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">V8 Sandbox - Readme</div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p><a class="anchor" id="autotoc_md22"></a></p>
<p>A low-overhead, in-process sandbox for V8.</p>
<p>The sandbox limits the impact of typical V8 vulnerabilities by restricting the code executed by V8 to a subset of the process' virtual address space ("the
sandbox"), thereby isolating it from the rest of the process. This works purely in software (with options for hardware support, see the respective design document linked below) by effectively converting raw pointers either into offsets from the base of the sandbox or into indices into out-of-sandbox pointer tables. In principle, these mechanisms are very similar to the userland/kernel separation used by modern operating systems (e.g. the unix file descriptor table).</p>
<p>The sandbox assumes that an attacker can arbitrarily and concurrently modify any memory inside the sandbox address space as this primitive can be constructed from typical V8 vulnerabilities. Further, it is assumed that an attacker will be able to read memory outside of the sandbox, for example through hardware side channels. The sandbox then aims to protect the rest of the process from such an attacker. As such, any corruption of memory outside of the sandbox address space is considered a sandbox violation.</p>
<h1><a class="anchor" id="autotoc_md23"></a>
Usage</h1>
<p>To enable the sandbox, simply use <code>v8_enable_sandbox = true</code> in the gn args. The sandbox is only available in 64-bit configurations as it requires large amounts of virtual address space. The sandbox is enabled by default on supported configurations.</p>
<h1><a class="anchor" id="autotoc_md24"></a>
Testing</h1>
<p>The sandbox is designed to be testable, both manually and automatically.</p>
<p>To use a "sandbox testing" configurations, two steps are required:</p>
<ol type="1">
<li>V8 needs to be build with <code>v8_enable_memory_corruption_api = true</code>. This will, when sandbox testing mode is enabled, expose a JavaScript <code>Sandbox</code> object through which memory inside the sandbox can be arbitrarily modified. This API effectively emulates common exploit primitives that can be constructed from a typical V8 vulnerability.</li>
<li>The sandbox testing mode needs to be enabled at runtime via either <code>--sandbox-testing</code> or <code>--sandbox-fuzzing</code>. This will expose the memory corruption API to JavaScript code and enable the sandbox crash filter, which will filter out uninteresting (for the sandbox) crashes such as access violations inside the sandbox or other unexploitable crashes. Note that the sandbox crash filter is currently only available on Linux.</li>
</ol>
<p>The following example demonstrates these two parts:</p>
<div class="fragment"><div class="line">// Create a DataView that can read and write inside the sandbox.</div>
<div class="line">let memory = new DataView(new Sandbox.MemoryView(0, 0x100000000));</div>
<div class="line"> </div>
<div class="line">// Create an object to corrupt and obtain its address inside the sandbox.</div>
<div class="line">let corruptMe = {};</div>
<div class="line">let addr = Sandbox.getAddressOf(corruptMe);</div>
<div class="line"> </div>
<div class="line">// Corrupt the object.</div>
<div class="line">memory.setUint32(addr, 0x41414141, true);</div>
<div class="line">memory.setUint32(addr + 4, 0x41414141, true);</div>
<div class="line">memory.setUint32(addr + 8, 0x41414141, true);</div>
<div class="line"> </div>
<div class="line">// Trigger a crash. The sandbox crash filter will catch it and determine that</div>
<div class="line">// this is _not_ a sandbox violation as it crashes inside the sandbox.</div>
<div class="line">corruptMe.crash();</div>
<div class="line"> </div>
<div class="line">// The process will now terminate cleanly with a message such as:</div>
<div class="line">// &quot;Caught harmless memory access violation (inside sandbox address space). Exiting process...&quot;</div>
</div><!-- fragment --><p>The &ndash;sandbox-testing and &ndash;sandbox-fuzzing flags are mostly identical. However, with &ndash;sandbox-testing, the process will terminate with exit status zero when detecting a harmless crash. As such, tests will be treated as passing if they crash safely such as for example through a CHECK failure. With &ndash;sandbox-fuzzing on the other hand, the process instead exits with a non-zero status so that fuzzers can determine that the execution terminated prematurely. Furthermore, the &ndash;sandbox-fuzzing requires the memory corruption API to be compiled in while &ndash;sandbox-testing can be enabled on any (sandbox-enabled) build. As such, &ndash;sandbox-fuzzing should generally be used for fuzzers while &ndash;sandbox-testing should be used for most other purposes.</p>
<p>Note that both &ndash;sandbox-testing and &ndash;sandbox-fuzzing will also report <em>reads</em> outside the sandbox as "sandbox violations". This is not technically true as the sandbox only attempts to prevent <em>writes</em>. However it is both difficult and undesirable to filter out reads, for example because in some cases, the underlying issue may also allow an attacker to perform a write instead.</p>
<h1><a class="anchor" id="autotoc_md25"></a>
Resources</h1>
<p>The following list contains further resources about the sandbox, in particular various design documents related to it.</p>
<ul>
<li><a href="https://v8.dev/blog/sandbox">Sandbox Blog Post</a>: Discusses the motivation behind the sandbox and its goals while also briefly covering the high-level design, performance characteristics, and testability aspects of the sandbox.</li>
<li><a href="https://docs.google.com/document/d/1FM4fQmIhEqPG8uGp5o9A-mnPB5BOeScZYpkHjo0KKA8/edit?usp=sharing">High-Level Design Document</a>: Discusses the attacker model, goal, and basic design of the sandbox, while linking to the more specific design documents below where appropriate.</li>
<li><a href="https://docs.google.com/document/d/1PM4Zqmlt8ac5O8UNQfY7fOsem-6MhbsB-vjFI-9XK6w/edit?usp=sharing">Sandbox Address Space</a>: Contains additional details about the address space reservation backing the sandbox and how it is allocated.</li>
<li><a href="https://docs.google.com/document/d/1HSap8-J3HcrZvT7-5NsbYWcjfc0BVoops5TDHZNsnko/edit?usp=sharing">Sandboxed Pointers</a>: Discusses the design of sandboxed pointers, which are pointers that are always guaranteed to point into the sandbox and are for example used to reference ArrayBuffer backing stores.</li>
<li><a href="https://docs.google.com/document/d/1V3sxltuFjjhp_6grGHgfqZNK57qfzGzme0QTk0IXDHk/edit?usp=sharing">External Pointer Table</a>: The external pointer table is used to securely reference non-V8 ("external") objects, for example objects owned by the Embedder, from inside the sandbox. This document discusses its design in more detail.</li>
<li><a href="https://docs.google.com/document/d/1CPs5PutbnmI-c5g7e_Td9CNGh5BvpLleKCqUnqmD82k/edit?usp=sharing">Code Pointer Sandboxing</a>: Similar to external objects, pointers to executable machine code also needs to be protected. This is done with the help of a dedicated code pointer table, which is discussed in this document.</li>
<li><a href="https://docs.google.com/document/d/1IrvzL4uX_Zv0k2Iakdp_q_z33bj-qlYF5IesGpXW0fM/edit?usp=sharing">Trusted Space</a>: Certain V8 objects are considered trusted and must not be corrupted by an attacker. Examples of such objects include bytecode containers and metadata for JIT-generated code. These objects are protected by allocating them outside of the sandbox in the trusted heap space, then referencing them through another pointer table indirection to ensure memory safe access. This document discusses both of these mechanisms.</li>
<li><a href="https://docs.google.com/document/d/12MsaG6BYRB-jQWNkZiuM3bY8X2B2cAsCMLLdgErvK4c/edit?usp=sharing">Hardware Support</a>: Instead of the purely software-based sandbox described by the preceeding documents, the sandbox could also be implemented (or augmented) with special hardware support. This document discusses various options for how that may work in practice, what the implications would be, and which requirements the hardware would have to fulfill. </li>
</ul>
</div></div><!-- contents -->
</div><!-- PageDoc -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0 </li>
  </ul>
</div>
</body>
</html>
