<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.12.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>v8: /home/w1redch4d/Documents/browser-exploitation/v8/v8/src/sandbox/sandbox.cc Source File</title>
<link rel="icon" href="v8.svg" type="image/x-icon" />
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectlogo"><img alt="Logo" src="v8.svg"/></td>
  <td id="projectalign">
   <div id="projectname">v8
   </div>
   <div id="projectbrief">V8 is Googleâ€™s open source high-performance JavaScript and WebAssembly engine, written in C++. It is used in Chrome and in Node.js, among others. It implements ECMAScript and WebAssembly, and runs on Windows, macOS, and Linux systems that use x64, IA-32, or ARM processors. V8 can be embedded into any C++ application.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.12.0 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() { codefold.init(0); });
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search',false);
  $(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function(){ initResizable(false); });
/* @license-end */
</script>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div id="nav-path" class="navpath">
  <ul>
<li class="navelem"><a class="el" href="dir_68267d1309a1af8e8297ef4c3efbcdba.html">src</a></li><li class="navelem"><a class="el" href="dir_2666c81470adc64840ad535dbb7c3c8b.html">sandbox</a></li>  </ul>
</div>
</div><!-- top -->
<div id="doc-content">
<div class="header">
  <div class="headertitle"><div class="title">sandbox.cc</div></div>
</div><!--header-->
<div class="contents">
<a href="sandbox_8cc.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a id="l00001" name="l00001"></a><span class="lineno">    1</span><span class="comment">// Copyright 2021 the V8 project authors. All rights reserved.</span></div>
<div class="line"><a id="l00002" name="l00002"></a><span class="lineno">    2</span><span class="comment">// Use of this source code is governed by a BSD-style license that can be</span></div>
<div class="line"><a id="l00003" name="l00003"></a><span class="lineno">    3</span><span class="comment">// found in the LICENSE file.</span></div>
<div class="line"><a id="l00004" name="l00004"></a><span class="lineno">    4</span> </div>
<div class="line"><a id="l00005" name="l00005"></a><span class="lineno">    5</span><span class="preprocessor">#include &quot;<a class="code" href="sandbox_8h.html">src/sandbox/sandbox.h</a>&quot;</span></div>
<div class="line"><a id="l00006" name="l00006"></a><span class="lineno">    6</span> </div>
<div class="line"><a id="l00007" name="l00007"></a><span class="lineno">    7</span><span class="preprocessor">#include &quot;include/v8-internal.h&quot;</span></div>
<div class="line"><a id="l00008" name="l00008"></a><span class="lineno">    8</span><span class="preprocessor">#include &quot;<a class="code" href="bits_8h.html">src/base/bits.h</a>&quot;</span></div>
<div class="line"><a id="l00009" name="l00009"></a><span class="lineno">    9</span><span class="preprocessor">#include &quot;<a class="code" href="bounded-page-allocator_8h.html">src/base/bounded-page-allocator.h</a>&quot;</span></div>
<div class="line"><a id="l00010" name="l00010"></a><span class="lineno">   10</span><span class="preprocessor">#include &quot;<a class="code" href="cpu_8h.html">src/base/cpu.h</a>&quot;</span></div>
<div class="line"><a id="l00011" name="l00011"></a><span class="lineno">   11</span><span class="preprocessor">#include &quot;<a class="code" href="emulated-virtual-address-subspace_8h.html">src/base/emulated-virtual-address-subspace.h</a>&quot;</span></div>
<div class="line"><a id="l00012" name="l00012"></a><span class="lineno">   12</span><span class="preprocessor">#include &quot;<a class="code" href="lazy-instance_8h.html">src/base/lazy-instance.h</a>&quot;</span></div>
<div class="line"><a id="l00013" name="l00013"></a><span class="lineno">   13</span><span class="preprocessor">#include &quot;<a class="code" href="sys-info_8h.html">src/base/sys-info.h</a>&quot;</span></div>
<div class="line"><a id="l00014" name="l00014"></a><span class="lineno">   14</span><span class="preprocessor">#include &quot;<a class="code" href="random-number-generator_8h.html">src/base/utils/random-number-generator.h</a>&quot;</span></div>
<div class="line"><a id="l00015" name="l00015"></a><span class="lineno">   15</span><span class="preprocessor">#include &quot;<a class="code" href="virtual-address-space-page-allocator_8h.html">src/base/virtual-address-space-page-allocator.h</a>&quot;</span></div>
<div class="line"><a id="l00016" name="l00016"></a><span class="lineno">   16</span><span class="preprocessor">#include &quot;<a class="code" href="virtual-address-space_8h.html">src/base/virtual-address-space.h</a>&quot;</span></div>
<div class="line"><a id="l00017" name="l00017"></a><span class="lineno">   17</span><span class="preprocessor">#include &quot;<a class="code" href="flags_2flags_8h.html">src/flags/flags.h</a>&quot;</span></div>
<div class="line"><a id="l00018" name="l00018"></a><span class="lineno">   18</span><span class="preprocessor">#include &quot;<a class="code" href="hardware-support_8h.html">src/sandbox/hardware-support.h</a>&quot;</span></div>
<div class="line"><a id="l00019" name="l00019"></a><span class="lineno">   19</span><span class="preprocessor">#include &quot;<a class="code" href="sandboxed-pointer_8h.html">src/sandbox/sandboxed-pointer.h</a>&quot;</span></div>
<div class="line"><a id="l00020" name="l00020"></a><span class="lineno">   20</span><span class="preprocessor">#include &quot;<a class="code" href="trap-handler_8h.html">src/trap-handler/trap-handler.h</a>&quot;</span></div>
<div class="line"><a id="l00021" name="l00021"></a><span class="lineno">   21</span><span class="preprocessor">#include &quot;<a class="code" href="allocation_8h.html">src/utils/allocation.h</a>&quot;</span></div>
<div class="line"><a id="l00022" name="l00022"></a><span class="lineno">   22</span> </div>
<div class="line"><a id="l00023" name="l00023"></a><span class="lineno">   23</span><span class="keyword">namespace </span><a class="code hl_namespace" href="namespacev8.html">v8</a> {</div>
<div class="line"><a id="l00024" name="l00024"></a><span class="lineno">   24</span><span class="keyword">namespace </span><a class="code hl_variable" href="namespacev8_1_1internal.html#a5031451934208565c827c86d9eb86c5a">internal</a> {</div>
<div class="line"><a id="l00025" name="l00025"></a><span class="lineno">   25</span> </div>
<div class="line"><a id="l00026" name="l00026"></a><span class="lineno">   26</span><span class="preprocessor">#ifdef V8_ENABLE_SANDBOX</span></div>
<div class="line"><a id="l00027" name="l00027"></a><span class="lineno">   27</span> </div>
<div class="line"><a id="l00028" name="l00028"></a><span class="lineno">   28</span><span class="keywordtype">bool</span> Sandbox::first_four_gb_of_address_space_are_reserved_ = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00029" name="l00029"></a><span class="lineno">   29</span> </div>
<div class="line"><a id="l00030" name="l00030"></a><span class="lineno">   30</span><span class="preprocessor">#ifdef V8_COMPRESS_POINTERS_IN_MULTIPLE_CAGES</span></div>
<div class="line"><a id="l00031" name="l00031"></a><span class="lineno">   31</span><span class="keyword">thread_local</span> Sandbox* Sandbox::current_ = <span class="keyword">nullptr</span>;</div>
<div class="line"><a id="l00032" name="l00032"></a><span class="lineno">   32</span><span class="comment">// static</span></div>
<div class="line"><a id="l00033" name="l00033"></a><span class="lineno">   33</span>Sandbox* Sandbox::current_non_inlined() { <span class="keywordflow">return</span> <a class="code hl_variable" href="regexp-parser_8cc.html#a2e1b080512a5c5e0ce8f64ded8138eac">current_</a>; }</div>
<div class="line"><a id="l00034" name="l00034"></a><span class="lineno">   34</span><span class="comment">// static</span></div>
<div class="line"><a id="l00035" name="l00035"></a><span class="lineno">   35</span><span class="keywordtype">void</span> Sandbox::set_current_non_inlined(Sandbox* sandbox) { <a class="code hl_variable" href="regexp-parser_8cc.html#a2e1b080512a5c5e0ce8f64ded8138eac">current_</a> = sandbox; }</div>
<div class="line"><a id="l00036" name="l00036"></a><span class="lineno">   36</span><span class="preprocessor">#endif  </span><span class="comment">// V8_COMPRESS_POINTERS_IN_MULTIPLE_CAGES</span></div>
<div class="line"><a id="l00037" name="l00037"></a><span class="lineno">   37</span> </div>
<div class="line"><a id="l00038" name="l00038"></a><span class="lineno">   38</span>Sandbox* Sandbox::default_sandbox_ = <span class="keyword">nullptr</span>;</div>
<div class="line"><a id="l00039" name="l00039"></a><span class="lineno">   39</span> </div>
<div class="line"><a id="l00040" name="l00040"></a><span class="lineno">   40</span><span class="comment">// Best-effort function to determine the approximate size of the virtual</span></div>
<div class="line"><a id="l00041" name="l00041"></a><span class="lineno">   41</span><span class="comment">// address space that can be addressed by this process. Used to determine</span></div>
<div class="line"><a id="l00042" name="l00042"></a><span class="lineno">   42</span><span class="comment">// appropriate sandbox size and placement.</span></div>
<div class="line"><a id="l00043" name="l00043"></a><span class="lineno">   43</span><span class="comment">// The value returned by this function will always be a power of two.</span></div>
<div class="line"><a id="l00044" name="l00044"></a><span class="lineno">   44</span><span class="keyword">static</span> <a class="code hl_variable" href="namespacev8_1_1internal.html#a782acb70e9eabcd3faaccfb6a3bde48e">Address</a> DetermineAddressSpaceLimit() {</div>
<div class="line"><a id="l00045" name="l00045"></a><span class="lineno">   45</span><span class="preprocessor">#ifndef V8_TARGET_ARCH_64_BIT</span></div>
<div class="line"><a id="l00046" name="l00046"></a><span class="lineno">   46</span><span class="preprocessor">#error Unsupported target architecture.</span></div>
<div class="line"><a id="l00047" name="l00047"></a><span class="lineno">   47</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00048" name="l00048"></a><span class="lineno">   48</span> </div>
<div class="line"><a id="l00049" name="l00049"></a><span class="lineno">   49</span>  <span class="comment">// Assume 48 bits by default, which seems to be the most common configuration.</span></div>
<div class="line"><a id="l00050" name="l00050"></a><span class="lineno">   50</span>  <span class="keyword">constexpr</span> <span class="keywordtype">unsigned</span> kDefaultVirtualAddressBits = 48;</div>
<div class="line"><a id="l00051" name="l00051"></a><span class="lineno">   51</span>  <span class="comment">// 36 bits should realistically be the lowest value we could ever see.</span></div>
<div class="line"><a id="l00052" name="l00052"></a><span class="lineno">   52</span>  <span class="keyword">constexpr</span> <span class="keywordtype">unsigned</span> kMinVirtualAddressBits = 36;</div>
<div class="line"><a id="l00053" name="l00053"></a><span class="lineno">   53</span>  <span class="keyword">constexpr</span> <span class="keywordtype">unsigned</span> kMaxVirtualAddressBits = 64;</div>
<div class="line"><a id="l00054" name="l00054"></a><span class="lineno">   54</span> </div>
<div class="line"><a id="l00055" name="l00055"></a><span class="lineno">   55</span>  <span class="keywordtype">unsigned</span> hardware_virtual_address_bits = kDefaultVirtualAddressBits;</div>
<div class="line"><a id="l00056" name="l00056"></a><span class="lineno">   56</span><span class="preprocessor">#if defined(V8_TARGET_ARCH_X64)</span></div>
<div class="line"><a id="l00057" name="l00057"></a><span class="lineno">   57</span>  base::CPU cpu;</div>
<div class="line"><a id="l00058" name="l00058"></a><span class="lineno">   58</span>  <span class="keywordflow">if</span> (cpu.exposes_num_virtual_address_bits()) {</div>
<div class="line"><a id="l00059" name="l00059"></a><span class="lineno">   59</span>    hardware_virtual_address_bits = cpu.num_virtual_address_bits();</div>
<div class="line"><a id="l00060" name="l00060"></a><span class="lineno">   60</span>  }</div>
<div class="line"><a id="l00061" name="l00061"></a><span class="lineno">   61</span><span class="preprocessor">#endif  </span><span class="comment">// V8_TARGET_ARCH_X64</span></div>
<div class="line"><a id="l00062" name="l00062"></a><span class="lineno">   62</span> </div>
<div class="line"><a id="l00063" name="l00063"></a><span class="lineno">   63</span><span class="preprocessor">#if defined(V8_TARGET_ARCH_ARM64) &amp;&amp; defined(V8_TARGET_OS_ANDROID)</span></div>
<div class="line"><a id="l00064" name="l00064"></a><span class="lineno">   64</span>  <span class="comment">// On Arm64 Android assume a 40-bit virtual address space (39 bits for</span></div>
<div class="line"><a id="l00065" name="l00065"></a><span class="lineno">   65</span>  <span class="comment">// userspace and kernel each) as that appears to be the most common</span></div>
<div class="line"><a id="l00066" name="l00066"></a><span class="lineno">   66</span>  <span class="comment">// configuration and there seems to be no easy way to retrieve the actual</span></div>
<div class="line"><a id="l00067" name="l00067"></a><span class="lineno">   67</span>  <span class="comment">// number of virtual address bits from the CPU in userspace.</span></div>
<div class="line"><a id="l00068" name="l00068"></a><span class="lineno">   68</span>  hardware_virtual_address_bits = 40;</div>
<div class="line"><a id="l00069" name="l00069"></a><span class="lineno">   69</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00070" name="l00070"></a><span class="lineno">   70</span> </div>
<div class="line"><a id="l00071" name="l00071"></a><span class="lineno">   71</span>  <span class="comment">// Assume virtual address space is split 50/50 between userspace and kernel.</span></div>
<div class="line"><a id="l00072" name="l00072"></a><span class="lineno">   72</span>  hardware_virtual_address_bits -= 1;</div>
<div class="line"><a id="l00073" name="l00073"></a><span class="lineno">   73</span> </div>
<div class="line"><a id="l00074" name="l00074"></a><span class="lineno">   74</span>  <span class="comment">// Check if there is a software-imposed limits on the size of the address</span></div>
<div class="line"><a id="l00075" name="l00075"></a><span class="lineno">   75</span>  <span class="comment">// space. For example, older Windows versions limit the address space to 8TB:</span></div>
<div class="line"><a id="l00076" name="l00076"></a><span class="lineno">   76</span>  <span class="comment">// https://learn.microsoft.com/en-us/windows/win32/memory/memory-limits-for-windows-releases).</span></div>
<div class="line"><a id="l00077" name="l00077"></a><span class="lineno">   77</span>  <a class="code hl_variable" href="namespacev8_1_1internal.html#a782acb70e9eabcd3faaccfb6a3bde48e">Address</a> software_limit = <a class="code hl_function" href="classv8_1_1base_1_1SysInfo.html#a5bfbc11d20bf73ed9cb8986c17d0ee4e">base::SysInfo::AddressSpaceEnd</a>();</div>
<div class="line"><a id="l00078" name="l00078"></a><span class="lineno">   78</span>  <span class="comment">// Compute the next power of two that is larger or equal to the limit.</span></div>
<div class="line"><a id="l00079" name="l00079"></a><span class="lineno">   79</span>  <span class="keywordtype">unsigned</span> software_virtual_address_bits =</div>
<div class="line"><a id="l00080" name="l00080"></a><span class="lineno">   80</span>      64 - <a class="code hl_function" href="namespacev8_1_1base_1_1bits.html#a05e2bc2d432bf561a7cf3ced275a87be">base::bits::CountLeadingZeros</a>(software_limit - 1);</div>
<div class="line"><a id="l00081" name="l00081"></a><span class="lineno">   81</span> </div>
<div class="line"><a id="l00082" name="l00082"></a><span class="lineno">   82</span>  <span class="comment">// The available address space is the smaller of the two limits.</span></div>
<div class="line"><a id="l00083" name="l00083"></a><span class="lineno">   83</span>  <span class="keywordtype">unsigned</span> virtual_address_bits =</div>
<div class="line"><a id="l00084" name="l00084"></a><span class="lineno">   84</span>      std::min(hardware_virtual_address_bits, software_virtual_address_bits);</div>
<div class="line"><a id="l00085" name="l00085"></a><span class="lineno">   85</span> </div>
<div class="line"><a id="l00086" name="l00086"></a><span class="lineno">   86</span>  <span class="comment">// Guard against nonsensical values.</span></div>
<div class="line"><a id="l00087" name="l00087"></a><span class="lineno">   87</span>  <span class="keywordflow">if</span> (virtual_address_bits &lt; kMinVirtualAddressBits ||</div>
<div class="line"><a id="l00088" name="l00088"></a><span class="lineno">   88</span>      virtual_address_bits &gt; kMaxVirtualAddressBits) {</div>
<div class="line"><a id="l00089" name="l00089"></a><span class="lineno">   89</span>    virtual_address_bits = kDefaultVirtualAddressBits;</div>
<div class="line"><a id="l00090" name="l00090"></a><span class="lineno">   90</span>  }</div>
<div class="line"><a id="l00091" name="l00091"></a><span class="lineno">   91</span> </div>
<div class="line"><a id="l00092" name="l00092"></a><span class="lineno">   92</span>  <span class="keywordflow">return</span> 1ULL &lt;&lt; virtual_address_bits;</div>
<div class="line"><a id="l00093" name="l00093"></a><span class="lineno">   93</span>}</div>
<div class="line"><a id="l00094" name="l00094"></a><span class="lineno">   94</span> </div>
<div class="line"><a id="l00095" name="l00095"></a><span class="lineno">   95</span><span class="keywordtype">void</span> Sandbox::Initialize(v8::VirtualAddressSpace* vas) {</div>
<div class="line"><a id="l00096" name="l00096"></a><span class="lineno">   96</span>  <span class="comment">// Take the size of the virtual address space into account when determining</span></div>
<div class="line"><a id="l00097" name="l00097"></a><span class="lineno">   97</span>  <span class="comment">// the size of the address space reservation backing the sandbox. For</span></div>
<div class="line"><a id="l00098" name="l00098"></a><span class="lineno">   98</span>  <span class="comment">// example, if we only have a 40-bit address space, split evenly between</span></div>
<div class="line"><a id="l00099" name="l00099"></a><span class="lineno">   99</span>  <span class="comment">// userspace and kernel, then userspace can only address 512GB and so we use</span></div>
<div class="line"><a id="l00100" name="l00100"></a><span class="lineno">  100</span>  <span class="comment">// a quarter of that, 128GB, as maximum reservation size.</span></div>
<div class="line"><a id="l00101" name="l00101"></a><span class="lineno">  101</span>  <a class="code hl_variable" href="namespacev8_1_1internal.html#a782acb70e9eabcd3faaccfb6a3bde48e">Address</a> address_space_limit = DetermineAddressSpaceLimit();</div>
<div class="line"><a id="l00102" name="l00102"></a><span class="lineno">  102</span>  <span class="comment">// Note: this is technically the maximum reservation size excluding the guard</span></div>
<div class="line"><a id="l00103" name="l00103"></a><span class="lineno">  103</span>  <span class="comment">// regions (which are not created for partially-reserved sandboxes).</span></div>
<div class="line"><a id="l00104" name="l00104"></a><span class="lineno">  104</span>  <span class="keywordtype">size_t</span> max_reservation_size = address_space_limit / 4;</div>
<div class="line"><a id="l00105" name="l00105"></a><span class="lineno">  105</span> </div>
<div class="line"><a id="l00106" name="l00106"></a><span class="lineno">  106</span>  <span class="comment">// In any case, the sandbox should be smaller than our address space since we</span></div>
<div class="line"><a id="l00107" name="l00107"></a><span class="lineno">  107</span>  <span class="comment">// otherwise wouldn&#39;t always be able to allocate objects inside of it.</span></div>
<div class="line"><a id="l00108" name="l00108"></a><span class="lineno">  108</span>  <a class="code hl_define" href="logging_8h.html#a45a0717f39b7011dc823c1fe7b83e6fc">CHECK_LT</a>(kSandboxSize, address_space_limit);</div>
<div class="line"><a id="l00109" name="l00109"></a><span class="lineno">  109</span> </div>
<div class="line"><a id="l00110" name="l00110"></a><span class="lineno">  110</span>  <span class="keywordflow">if</span> (!vas-&gt;CanAllocateSubspaces()) {</div>
<div class="line"><a id="l00111" name="l00111"></a><span class="lineno">  111</span>    <span class="comment">// If we cannot create virtual memory subspaces, we fall back to creating a</span></div>
<div class="line"><a id="l00112" name="l00112"></a><span class="lineno">  112</span>    <span class="comment">// partially reserved sandbox. This will happen for example on older</span></div>
<div class="line"><a id="l00113" name="l00113"></a><span class="lineno">  113</span>    <span class="comment">// Windows versions (before Windows 10) where the necessary memory</span></div>
<div class="line"><a id="l00114" name="l00114"></a><span class="lineno">  114</span>    <span class="comment">// management APIs, in particular, VirtualAlloc2, are not available.</span></div>
<div class="line"><a id="l00115" name="l00115"></a><span class="lineno">  115</span>    <span class="comment">// Since reserving virtual memory is an expensive operation on Windows</span></div>
<div class="line"><a id="l00116" name="l00116"></a><span class="lineno">  116</span>    <span class="comment">// before version 8.1 (reserving 1TB of address space will increase private</span></div>
<div class="line"><a id="l00117" name="l00117"></a><span class="lineno">  117</span>    <span class="comment">// memory usage by around 2GB), we only reserve the minimal amount of</span></div>
<div class="line"><a id="l00118" name="l00118"></a><span class="lineno">  118</span>    <span class="comment">// address space here. This way, we don&#39;t incur the cost of reserving</span></div>
<div class="line"><a id="l00119" name="l00119"></a><span class="lineno">  119</span>    <span class="comment">// virtual memory, but also don&#39;t get the desired security properties as</span></div>
<div class="line"><a id="l00120" name="l00120"></a><span class="lineno">  120</span>    <span class="comment">// unrelated mappings may end up inside the sandbox.</span></div>
<div class="line"><a id="l00121" name="l00121"></a><span class="lineno">  121</span>    max_reservation_size = kSandboxMinimumReservationSize;</div>
<div class="line"><a id="l00122" name="l00122"></a><span class="lineno">  122</span>  }</div>
<div class="line"><a id="l00123" name="l00123"></a><span class="lineno">  123</span> </div>
<div class="line"><a id="l00124" name="l00124"></a><span class="lineno">  124</span>  <span class="comment">// If the maximum reservation size is less than the size of the sandbox, we</span></div>
<div class="line"><a id="l00125" name="l00125"></a><span class="lineno">  125</span>  <span class="comment">// can only create a partially-reserved sandbox.</span></div>
<div class="line"><a id="l00126" name="l00126"></a><span class="lineno">  126</span>  <span class="keywordtype">bool</span> success;</div>
<div class="line"><a id="l00127" name="l00127"></a><span class="lineno">  127</span>  <span class="keywordtype">size_t</span> reservation_size = std::min(kSandboxSize, max_reservation_size);</div>
<div class="line"><a id="l00128" name="l00128"></a><span class="lineno">  128</span>  <a class="code hl_define" href="logging_8h.html#ae17f8119c108cf3070bad3449c7e0006">DCHECK</a>(<a class="code hl_function" href="namespacev8_1_1base_1_1bits.html#a4d06086712ebcd60838caae1a21fcfa3">base::bits::IsPowerOfTwo</a>(reservation_size));</div>
<div class="line"><a id="l00129" name="l00129"></a><span class="lineno">  129</span>  <span class="keywordflow">if</span> (reservation_size &lt; kSandboxSize) {</div>
<div class="line"><a id="l00130" name="l00130"></a><span class="lineno">  130</span>    <a class="code hl_define" href="logging_8h.html#aabec5c3b7a8628298a25f044dcf89c25">DCHECK_GE</a>(max_reservation_size, kSandboxMinimumReservationSize);</div>
<div class="line"><a id="l00131" name="l00131"></a><span class="lineno">  131</span>    success = InitializeAsPartiallyReservedSandbox(vas, kSandboxSize,</div>
<div class="line"><a id="l00132" name="l00132"></a><span class="lineno">  132</span>                                                   reservation_size);</div>
<div class="line"><a id="l00133" name="l00133"></a><span class="lineno">  133</span>  } <span class="keywordflow">else</span> {</div>
<div class="line"><a id="l00134" name="l00134"></a><span class="lineno">  134</span>    <a class="code hl_define" href="logging_8h.html#af9c313d74155f7f201955a939e24c71f">DCHECK_EQ</a>(kSandboxSize, reservation_size);</div>
<div class="line"><a id="l00135" name="l00135"></a><span class="lineno">  135</span>    <span class="keyword">constexpr</span> <span class="keywordtype">bool</span> use_guard_regions = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00136" name="l00136"></a><span class="lineno">  136</span>    success = Initialize(vas, kSandboxSize, use_guard_regions);</div>
<div class="line"><a id="l00137" name="l00137"></a><span class="lineno">  137</span>  }</div>
<div class="line"><a id="l00138" name="l00138"></a><span class="lineno">  138</span> </div>
<div class="line"><a id="l00139" name="l00139"></a><span class="lineno">  139</span>  <span class="comment">// Fall back to creating a (smaller) partially reserved sandbox.</span></div>
<div class="line"><a id="l00140" name="l00140"></a><span class="lineno">  140</span>  <span class="keywordflow">while</span> (!success &amp;&amp; reservation_size &gt; kSandboxMinimumReservationSize) {</div>
<div class="line"><a id="l00141" name="l00141"></a><span class="lineno">  141</span>    <span class="keyword">static_assert</span>(kFallbackToPartiallyReservedSandboxAllowed);</div>
<div class="line"><a id="l00142" name="l00142"></a><span class="lineno">  142</span>    reservation_size /= 2;</div>
<div class="line"><a id="l00143" name="l00143"></a><span class="lineno">  143</span>    <a class="code hl_define" href="logging_8h.html#aabec5c3b7a8628298a25f044dcf89c25">DCHECK_GE</a>(reservation_size, kSandboxMinimumReservationSize);</div>
<div class="line"><a id="l00144" name="l00144"></a><span class="lineno">  144</span>    success = InitializeAsPartiallyReservedSandbox(vas, kSandboxSize,</div>
<div class="line"><a id="l00145" name="l00145"></a><span class="lineno">  145</span>                                                   reservation_size);</div>
<div class="line"><a id="l00146" name="l00146"></a><span class="lineno">  146</span>  }</div>
<div class="line"><a id="l00147" name="l00147"></a><span class="lineno">  147</span> </div>
<div class="line"><a id="l00148" name="l00148"></a><span class="lineno">  148</span>  <span class="keywordflow">if</span> (!success) {</div>
<div class="line"><a id="l00149" name="l00149"></a><span class="lineno">  149</span>    <a class="code hl_function" href="classv8_1_1internal_1_1V8.html#a977b087d4ee58955efe72b33136a4e94">V8::FatalProcessOutOfMemory</a>(</div>
<div class="line"><a id="l00150" name="l00150"></a><span class="lineno">  150</span>        <span class="keyword">nullptr</span>,</div>
<div class="line"><a id="l00151" name="l00151"></a><span class="lineno">  151</span>        <span class="stringliteral">&quot;Failed to reserve the virtual address space for the V8 sandbox&quot;</span>);</div>
<div class="line"><a id="l00152" name="l00152"></a><span class="lineno">  152</span>  }</div>
<div class="line"><a id="l00153" name="l00153"></a><span class="lineno">  153</span> </div>
<div class="line"><a id="l00154" name="l00154"></a><span class="lineno">  154</span><span class="preprocessor">#if V8_ENABLE_WEBASSEMBLY &amp;&amp; V8_TRAP_HANDLER_SUPPORTED</span></div>
<div class="line"><a id="l00155" name="l00155"></a><span class="lineno">  155</span>  <a class="code hl_function" href="namespacev8_1_1internal_1_1trap__handler.html#a3ab5bab37e5ef18e3204bfc48aa1ada0">trap_handler::SetV8SandboxBaseAndSize</a>(<a class="code hl_variable" href="instruction-selector-ia32_8cc.html#a115c48491bb37004f5ac67eb46ac2c23">base</a>(), <a class="code hl_variable" href="setup-heap-internal_8cc.html#a439227feff9d7f55384e8780cfc2eb82">size</a>());</div>
<div class="line"><a id="l00156" name="l00156"></a><span class="lineno">  156</span><span class="preprocessor">#endif  </span><span class="comment">// V8_ENABLE_WEBASSEMBLY &amp;&amp; V8_TRAP_HANDLER_SUPPORTED</span></div>
<div class="line"><a id="l00157" name="l00157"></a><span class="lineno">  157</span> </div>
<div class="line"><a id="l00158" name="l00158"></a><span class="lineno">  158</span>  <a class="code hl_function" href="classv8_1_1internal_1_1SandboxHardwareSupport.html#a71342ee373995ec74a61e8a3f0a08d4b">SandboxHardwareSupport::TryEnable</a>(<a class="code hl_variable" href="instruction-selector-ia32_8cc.html#a115c48491bb37004f5ac67eb46ac2c23">base</a>(), <a class="code hl_variable" href="setup-heap-internal_8cc.html#a439227feff9d7f55384e8780cfc2eb82">size</a>());</div>
<div class="line"><a id="l00159" name="l00159"></a><span class="lineno">  159</span> </div>
<div class="line"><a id="l00160" name="l00160"></a><span class="lineno">  160</span>  <a class="code hl_define" href="logging_8h.html#ae17f8119c108cf3070bad3449c7e0006">DCHECK</a>(initialized_);</div>
<div class="line"><a id="l00161" name="l00161"></a><span class="lineno">  161</span>}</div>
<div class="line"><a id="l00162" name="l00162"></a><span class="lineno">  162</span> </div>
<div class="line"><a id="l00163" name="l00163"></a><span class="lineno">  163</span><span class="keywordtype">bool</span> Sandbox::Initialize(v8::VirtualAddressSpace* vas, <span class="keywordtype">size_t</span> size,</div>
<div class="line"><a id="l00164" name="l00164"></a><span class="lineno">  164</span>                         <span class="keywordtype">bool</span> use_guard_regions) {</div>
<div class="line"><a id="l00165" name="l00165"></a><span class="lineno">  165</span>  <a class="code hl_define" href="logging_8h.html#a3e1cfef60e774a81f30eaddf26a3a274">CHECK</a>(!initialized_);</div>
<div class="line"><a id="l00166" name="l00166"></a><span class="lineno">  166</span>  <a class="code hl_define" href="logging_8h.html#a3e1cfef60e774a81f30eaddf26a3a274">CHECK</a>(<a class="code hl_function" href="namespacev8_1_1base_1_1bits.html#a4d06086712ebcd60838caae1a21fcfa3">base::bits::IsPowerOfTwo</a>(size));</div>
<div class="line"><a id="l00167" name="l00167"></a><span class="lineno">  167</span>  <a class="code hl_define" href="logging_8h.html#a3e1cfef60e774a81f30eaddf26a3a274">CHECK</a>(vas-&gt;CanAllocateSubspaces());</div>
<div class="line"><a id="l00168" name="l00168"></a><span class="lineno">  168</span> </div>
<div class="line"><a id="l00169" name="l00169"></a><span class="lineno">  169</span>  <span class="keywordtype">size_t</span> reservation_size = <a class="code hl_variable" href="setup-heap-internal_8cc.html#a439227feff9d7f55384e8780cfc2eb82">size</a>;</div>
<div class="line"><a id="l00170" name="l00170"></a><span class="lineno">  170</span>  <span class="comment">// As a temporary workaround for crbug.com/40070746 we use larger guard</span></div>
<div class="line"><a id="l00171" name="l00171"></a><span class="lineno">  171</span>  <span class="comment">// regions at the end of the sandbox.</span></div>
<div class="line"><a id="l00172" name="l00172"></a><span class="lineno">  172</span>  <span class="comment">// TODO(40070746): remove this workaround again once we have a proper fix.</span></div>
<div class="line"><a id="l00173" name="l00173"></a><span class="lineno">  173</span>  <span class="keywordtype">size_t</span> true_reservation_size = <a class="code hl_variable" href="setup-heap-internal_8cc.html#a439227feff9d7f55384e8780cfc2eb82">size</a>;</div>
<div class="line"><a id="l00174" name="l00174"></a><span class="lineno">  174</span><span class="preprocessor">#if defined(V8_TARGET_OS_ANDROID)</span></div>
<div class="line"><a id="l00175" name="l00175"></a><span class="lineno">  175</span>  <span class="comment">// On Android, we often won&#39;t have sufficient virtual address space available.</span></div>
<div class="line"><a id="l00176" name="l00176"></a><span class="lineno">  176</span>  <span class="keyword">const</span> <span class="keywordtype">size_t</span> kAdditionalTrailingGuardRegionSize = 0;</div>
<div class="line"><a id="l00177" name="l00177"></a><span class="lineno">  177</span><span class="preprocessor">#else</span></div>
<div class="line"><a id="l00178" name="l00178"></a><span class="lineno">  178</span>  <span class="comment">// Worst-case, we currently need 8 (max element size) * 32GB (max ArrayBuffer</span></div>
<div class="line"><a id="l00179" name="l00179"></a><span class="lineno">  179</span>  <span class="comment">// size) + 4GB (additional offset for TypedArray access).</span></div>
<div class="line"><a id="l00180" name="l00180"></a><span class="lineno">  180</span>  <span class="keyword">const</span> <span class="keywordtype">size_t</span> kTotalTrailingGuardRegionSize = 260ULL * GB;</div>
<div class="line"><a id="l00181" name="l00181"></a><span class="lineno">  181</span>  <span class="keyword">const</span> <span class="keywordtype">size_t</span> kAdditionalTrailingGuardRegionSize =</div>
<div class="line"><a id="l00182" name="l00182"></a><span class="lineno">  182</span>      kTotalTrailingGuardRegionSize - kSandboxGuardRegionSize;</div>
<div class="line"><a id="l00183" name="l00183"></a><span class="lineno">  183</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00184" name="l00184"></a><span class="lineno">  184</span>  <span class="keywordflow">if</span> (use_guard_regions) {</div>
<div class="line"><a id="l00185" name="l00185"></a><span class="lineno">  185</span>    reservation_size += 2 * kSandboxGuardRegionSize;</div>
<div class="line"><a id="l00186" name="l00186"></a><span class="lineno">  186</span>    true_reservation_size =</div>
<div class="line"><a id="l00187" name="l00187"></a><span class="lineno">  187</span>        reservation_size + kAdditionalTrailingGuardRegionSize;</div>
<div class="line"><a id="l00188" name="l00188"></a><span class="lineno">  188</span>  }</div>
<div class="line"><a id="l00189" name="l00189"></a><span class="lineno">  189</span> </div>
<div class="line"><a id="l00190" name="l00190"></a><span class="lineno">  190</span>  <a class="code hl_variable" href="namespacev8_1_1internal.html#a782acb70e9eabcd3faaccfb6a3bde48e">Address</a> hint = <a class="code hl_function" href="macros_8h.html#aa0de4a420e74c8df8076fc2aaf4af27a">RoundDown</a>(vas-&gt;RandomPageAddress(), kSandboxAlignment);</div>
<div class="line"><a id="l00191" name="l00191"></a><span class="lineno">  191</span> </div>
<div class="line"><a id="l00192" name="l00192"></a><span class="lineno">  192</span>  <span class="comment">// There should be no executable pages mapped inside the sandbox since</span></div>
<div class="line"><a id="l00193" name="l00193"></a><span class="lineno">  193</span>  <span class="comment">// those could be corrupted by an attacker and therefore pose a security</span></div>
<div class="line"><a id="l00194" name="l00194"></a><span class="lineno">  194</span>  <span class="comment">// risk. Furthermore, allowing executable mappings in the sandbox requires</span></div>
<div class="line"><a id="l00195" name="l00195"></a><span class="lineno">  195</span>  <span class="comment">// MAP_JIT on macOS, which causes fork() to become excessively slow</span></div>
<div class="line"><a id="l00196" name="l00196"></a><span class="lineno">  196</span>  <span class="comment">// (multiple seconds or even minutes for a 1TB sandbox on macOS 12.X), in</span></div>
<div class="line"><a id="l00197" name="l00197"></a><span class="lineno">  197</span>  <span class="comment">// turn causing tests to time out. As such, the maximum page permission</span></div>
<div class="line"><a id="l00198" name="l00198"></a><span class="lineno">  198</span>  <span class="comment">// inside the sandbox should be read + write.</span></div>
<div class="line"><a id="l00199" name="l00199"></a><span class="lineno">  199</span>  address_space_ =</div>
<div class="line"><a id="l00200" name="l00200"></a><span class="lineno">  200</span>      vas-&gt;AllocateSubspace(hint, true_reservation_size, kSandboxAlignment,</div>
<div class="line"><a id="l00201" name="l00201"></a><span class="lineno">  201</span>                            PagePermissions::kReadWrite);</div>
<div class="line"><a id="l00202" name="l00202"></a><span class="lineno">  202</span> </div>
<div class="line"><a id="l00203" name="l00203"></a><span class="lineno">  203</span>  <span class="keywordflow">if</span> (!address_space_) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l00204" name="l00204"></a><span class="lineno">  204</span> </div>
<div class="line"><a id="l00205" name="l00205"></a><span class="lineno">  205</span>  reservation_base_ = address_space_-&gt;base();</div>
<div class="line"><a id="l00206" name="l00206"></a><span class="lineno">  206</span>  <a class="code hl_variable" href="instruction-selector-arm64_8cc.html#a0715e37648068c3100161798fc42a972">base_</a> = reservation_base_ + (use_guard_regions ? kSandboxGuardRegionSize : 0);</div>
<div class="line"><a id="l00207" name="l00207"></a><span class="lineno">  207</span>  <a class="code hl_variable" href="codegen_2assembler_8cc.html#a50218915641ec8f39877c2565e95a604">size_</a> = <a class="code hl_variable" href="setup-heap-internal_8cc.html#a439227feff9d7f55384e8780cfc2eb82">size</a>;</div>
<div class="line"><a id="l00208" name="l00208"></a><span class="lineno">  208</span>  <a class="code hl_variable" href="cppgc_2sweeper_8cc.html#a69a1b0005c5803e98bd8cbe2ef95d570">end_</a> = <a class="code hl_variable" href="instruction-selector-arm64_8cc.html#a0715e37648068c3100161798fc42a972">base_</a> + <a class="code hl_variable" href="codegen_2assembler_8cc.html#a50218915641ec8f39877c2565e95a604">size_</a>;</div>
<div class="line"><a id="l00209" name="l00209"></a><span class="lineno">  209</span>  reservation_size_ = reservation_size;</div>
<div class="line"><a id="l00210" name="l00210"></a><span class="lineno">  210</span>  sandbox_page_allocator_ =</div>
<div class="line"><a id="l00211" name="l00211"></a><span class="lineno">  211</span>      std::make_unique&lt;base::VirtualAddressSpacePageAllocator&gt;(</div>
<div class="line"><a id="l00212" name="l00212"></a><span class="lineno">  212</span>          address_space_.get());</div>
<div class="line"><a id="l00213" name="l00213"></a><span class="lineno">  213</span> </div>
<div class="line"><a id="l00214" name="l00214"></a><span class="lineno">  214</span>  <span class="keywordflow">if</span> (use_guard_regions) {</div>
<div class="line"><a id="l00215" name="l00215"></a><span class="lineno">  215</span>    <a class="code hl_variable" href="namespacev8_1_1internal.html#a782acb70e9eabcd3faaccfb6a3bde48e">Address</a> front = reservation_base_;</div>
<div class="line"><a id="l00216" name="l00216"></a><span class="lineno">  216</span>    <a class="code hl_variable" href="namespacev8_1_1internal.html#a782acb70e9eabcd3faaccfb6a3bde48e">Address</a> back = <a class="code hl_variable" href="cppgc_2sweeper_8cc.html#a69a1b0005c5803e98bd8cbe2ef95d570">end_</a>;</div>
<div class="line"><a id="l00217" name="l00217"></a><span class="lineno">  217</span>    <span class="comment">// These must succeed since nothing was allocated in the subspace yet.</span></div>
<div class="line"><a id="l00218" name="l00218"></a><span class="lineno">  218</span>    <a class="code hl_define" href="logging_8h.html#a3e1cfef60e774a81f30eaddf26a3a274">CHECK</a>(address_space_-&gt;AllocateGuardRegion(front, kSandboxGuardRegionSize));</div>
<div class="line"><a id="l00219" name="l00219"></a><span class="lineno">  219</span>    <a class="code hl_define" href="logging_8h.html#a3e1cfef60e774a81f30eaddf26a3a274">CHECK</a>(address_space_-&gt;AllocateGuardRegion(</div>
<div class="line"><a id="l00220" name="l00220"></a><span class="lineno">  220</span>        back, kSandboxGuardRegionSize + kAdditionalTrailingGuardRegionSize));</div>
<div class="line"><a id="l00221" name="l00221"></a><span class="lineno">  221</span>  }</div>
<div class="line"><a id="l00222" name="l00222"></a><span class="lineno">  222</span> </div>
<div class="line"><a id="l00223" name="l00223"></a><span class="lineno">  223</span>  <span class="comment">// Also try to reserve the first 4GB of the process&#39; address space. This</span></div>
<div class="line"><a id="l00224" name="l00224"></a><span class="lineno">  224</span>  <span class="comment">// mitigates Smi&lt;-&gt;HeapObject confusion bugs in which we end up treating a</span></div>
<div class="line"><a id="l00225" name="l00225"></a><span class="lineno">  225</span>  <span class="comment">// Smi value as a pointer.</span></div>
<div class="line"><a id="l00226" name="l00226"></a><span class="lineno">  226</span>  <span class="keywordflow">if</span> (!first_four_gb_of_address_space_are_reserved_) {</div>
<div class="line"><a id="l00227" name="l00227"></a><span class="lineno">  227</span>    <a class="code hl_variable" href="namespacev8_1_1internal.html#a782acb70e9eabcd3faaccfb6a3bde48e">Address</a> <a class="code hl_variable" href="debug-coverage_8cc.html#abce9f5dc9c83f2639b72024fdee5d388">end</a> = 4UL * GB;</div>
<div class="line"><a id="l00228" name="l00228"></a><span class="lineno">  228</span>    <span class="keywordtype">size_t</span> step = address_space_-&gt;allocation_granularity();</div>
<div class="line"><a id="l00229" name="l00229"></a><span class="lineno">  229</span>    <span class="keywordflow">for</span> (<a class="code hl_variable" href="namespacev8_1_1internal.html#a782acb70e9eabcd3faaccfb6a3bde48e">Address</a> <a class="code hl_variable" href="debug-coverage_8cc.html#a37722a150250e2a5a98e5e0d11e53449">start</a> = 0; <a class="code hl_variable" href="debug-coverage_8cc.html#a37722a150250e2a5a98e5e0d11e53449">start</a> &lt;= 1 * <a class="code hl_variable" href="namespacev8_1_1internal.html#a08e1140ec7d96bfd4d6b21a808ccd654">MB</a>; <a class="code hl_variable" href="debug-coverage_8cc.html#a37722a150250e2a5a98e5e0d11e53449">start</a> += step) {</div>
<div class="line"><a id="l00230" name="l00230"></a><span class="lineno">  230</span>      <span class="keywordflow">if</span> (vas-&gt;AllocateGuardRegion(<a class="code hl_variable" href="debug-coverage_8cc.html#a37722a150250e2a5a98e5e0d11e53449">start</a>, <a class="code hl_variable" href="debug-coverage_8cc.html#abce9f5dc9c83f2639b72024fdee5d388">end</a> - <a class="code hl_variable" href="debug-coverage_8cc.html#a37722a150250e2a5a98e5e0d11e53449">start</a>)) {</div>
<div class="line"><a id="l00231" name="l00231"></a><span class="lineno">  231</span>        first_four_gb_of_address_space_are_reserved_ = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00232" name="l00232"></a><span class="lineno">  232</span>        <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00233" name="l00233"></a><span class="lineno">  233</span>      }</div>
<div class="line"><a id="l00234" name="l00234"></a><span class="lineno">  234</span>    }</div>
<div class="line"><a id="l00235" name="l00235"></a><span class="lineno">  235</span>  }</div>
<div class="line"><a id="l00236" name="l00236"></a><span class="lineno">  236</span> </div>
<div class="line"><a id="l00237" name="l00237"></a><span class="lineno">  237</span>  initialized_ = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00238" name="l00238"></a><span class="lineno">  238</span> </div>
<div class="line"><a id="l00239" name="l00239"></a><span class="lineno">  239</span>  FinishInitialization();</div>
<div class="line"><a id="l00240" name="l00240"></a><span class="lineno">  240</span> </div>
<div class="line"><a id="l00241" name="l00241"></a><span class="lineno">  241</span>  <a class="code hl_define" href="logging_8h.html#ae17f8119c108cf3070bad3449c7e0006">DCHECK</a>(!is_partially_reserved());</div>
<div class="line"><a id="l00242" name="l00242"></a><span class="lineno">  242</span>  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l00243" name="l00243"></a><span class="lineno">  243</span>}</div>
<div class="line"><a id="l00244" name="l00244"></a><span class="lineno">  244</span> </div>
<div class="line"><a id="l00245" name="l00245"></a><span class="lineno">  245</span><span class="keywordtype">bool</span> Sandbox::InitializeAsPartiallyReservedSandbox(v8::VirtualAddressSpace* vas,</div>
<div class="line"><a id="l00246" name="l00246"></a><span class="lineno">  246</span>                                                   <span class="keywordtype">size_t</span> size,</div>
<div class="line"><a id="l00247" name="l00247"></a><span class="lineno">  247</span>                                                   <span class="keywordtype">size_t</span> size_to_reserve) {</div>
<div class="line"><a id="l00248" name="l00248"></a><span class="lineno">  248</span>  <a class="code hl_define" href="logging_8h.html#a3e1cfef60e774a81f30eaddf26a3a274">CHECK</a>(!initialized_);</div>
<div class="line"><a id="l00249" name="l00249"></a><span class="lineno">  249</span>  <a class="code hl_define" href="logging_8h.html#a3e1cfef60e774a81f30eaddf26a3a274">CHECK</a>(<a class="code hl_function" href="namespacev8_1_1base_1_1bits.html#a4d06086712ebcd60838caae1a21fcfa3">base::bits::IsPowerOfTwo</a>(size));</div>
<div class="line"><a id="l00250" name="l00250"></a><span class="lineno">  250</span>  <a class="code hl_define" href="logging_8h.html#a3e1cfef60e774a81f30eaddf26a3a274">CHECK</a>(<a class="code hl_function" href="namespacev8_1_1base_1_1bits.html#a4d06086712ebcd60838caae1a21fcfa3">base::bits::IsPowerOfTwo</a>(size_to_reserve));</div>
<div class="line"><a id="l00251" name="l00251"></a><span class="lineno">  251</span>  <a class="code hl_define" href="logging_8h.html#a45a0717f39b7011dc823c1fe7b83e6fc">CHECK_LT</a>(size_to_reserve, size);</div>
<div class="line"><a id="l00252" name="l00252"></a><span class="lineno">  252</span> </div>
<div class="line"><a id="l00253" name="l00253"></a><span class="lineno">  253</span>  <span class="comment">// Use a custom random number generator here to ensure that we get uniformly</span></div>
<div class="line"><a id="l00254" name="l00254"></a><span class="lineno">  254</span>  <span class="comment">// distributed random numbers. We figure out the available address space</span></div>
<div class="line"><a id="l00255" name="l00255"></a><span class="lineno">  255</span>  <span class="comment">// ourselves, and so are potentially better positioned to determine a good</span></div>
<div class="line"><a id="l00256" name="l00256"></a><span class="lineno">  256</span>  <span class="comment">// base address for the sandbox than the embedder.</span></div>
<div class="line"><a id="l00257" name="l00257"></a><span class="lineno">  257</span>  base::RandomNumberGenerator rng;</div>
<div class="line"><a id="l00258" name="l00258"></a><span class="lineno">  258</span>  <span class="keywordflow">if</span> (<a class="code hl_variable" href="namespacev8_1_1internal.html#aa9db791c05a0359859a321dcfec42e37">v8_flags</a>.random_seed != 0) {</div>
<div class="line"><a id="l00259" name="l00259"></a><span class="lineno">  259</span>    rng.SetSeed(<a class="code hl_variable" href="namespacev8_1_1internal.html#aa9db791c05a0359859a321dcfec42e37">v8_flags</a>.random_seed);</div>
<div class="line"><a id="l00260" name="l00260"></a><span class="lineno">  260</span>  }</div>
<div class="line"><a id="l00261" name="l00261"></a><span class="lineno">  261</span> </div>
<div class="line"><a id="l00262" name="l00262"></a><span class="lineno">  262</span>  <span class="comment">// We try to ensure that base + size is still (mostly) within the process&#39;</span></div>
<div class="line"><a id="l00263" name="l00263"></a><span class="lineno">  263</span>  <span class="comment">// address space, even though we only reserve a fraction of the memory. For</span></div>
<div class="line"><a id="l00264" name="l00264"></a><span class="lineno">  264</span>  <span class="comment">// that, we attempt to map the sandbox into the first half of the usable</span></div>
<div class="line"><a id="l00265" name="l00265"></a><span class="lineno">  265</span>  <span class="comment">// address space. This keeps the implementation simple and should, In any</span></div>
<div class="line"><a id="l00266" name="l00266"></a><span class="lineno">  266</span>  <span class="comment">// realistic scenario, leave plenty of space after the actual reservation.</span></div>
<div class="line"><a id="l00267" name="l00267"></a><span class="lineno">  267</span>  <a class="code hl_variable" href="namespacev8_1_1internal.html#a782acb70e9eabcd3faaccfb6a3bde48e">Address</a> address_space_end = DetermineAddressSpaceLimit();</div>
<div class="line"><a id="l00268" name="l00268"></a><span class="lineno">  268</span>  <a class="code hl_variable" href="namespacev8_1_1internal.html#a782acb70e9eabcd3faaccfb6a3bde48e">Address</a> highest_allowed_address = address_space_end / 2;</div>
<div class="line"><a id="l00269" name="l00269"></a><span class="lineno">  269</span>  <a class="code hl_define" href="logging_8h.html#ae17f8119c108cf3070bad3449c7e0006">DCHECK</a>(<a class="code hl_function" href="namespacev8_1_1base_1_1bits.html#a4d06086712ebcd60838caae1a21fcfa3">base::bits::IsPowerOfTwo</a>(highest_allowed_address));</div>
<div class="line"><a id="l00270" name="l00270"></a><span class="lineno">  270</span>  <span class="keyword">constexpr</span> <span class="keywordtype">int</span> kMaxAttempts = 10;</div>
<div class="line"><a id="l00271" name="l00271"></a><span class="lineno">  271</span>  <span class="keywordflow">for</span> (<span class="keywordtype">int</span> <a class="code hl_namespace" href="namespacev8_1_1internal.html">i</a> = 1; <a class="code hl_namespace" href="namespacev8_1_1internal.html">i</a> &lt;= kMaxAttempts; <a class="code hl_namespace" href="namespacev8_1_1internal.html">i</a>++) {</div>
<div class="line"><a id="l00272" name="l00272"></a><span class="lineno">  272</span>    <a class="code hl_variable" href="namespacev8_1_1internal.html#a782acb70e9eabcd3faaccfb6a3bde48e">Address</a> hint = rng.NextInt64() % highest_allowed_address;</div>
<div class="line"><a id="l00273" name="l00273"></a><span class="lineno">  273</span>    hint = <a class="code hl_function" href="macros_8h.html#aa0de4a420e74c8df8076fc2aaf4af27a">RoundDown</a>(hint, kSandboxAlignment);</div>
<div class="line"><a id="l00274" name="l00274"></a><span class="lineno">  274</span> </div>
<div class="line"><a id="l00275" name="l00275"></a><span class="lineno">  275</span>    reservation_base_ = vas-&gt;AllocatePages(</div>
<div class="line"><a id="l00276" name="l00276"></a><span class="lineno">  276</span>        hint, size_to_reserve, kSandboxAlignment, PagePermissions::kNoAccess);</div>
<div class="line"><a id="l00277" name="l00277"></a><span class="lineno">  277</span> </div>
<div class="line"><a id="l00278" name="l00278"></a><span class="lineno">  278</span>    <span class="keywordflow">if</span> (!reservation_base_) <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line"><a id="l00279" name="l00279"></a><span class="lineno">  279</span> </div>
<div class="line"><a id="l00280" name="l00280"></a><span class="lineno">  280</span>    <span class="comment">// Take this base if it meets the requirements or if this is the last</span></div>
<div class="line"><a id="l00281" name="l00281"></a><span class="lineno">  281</span>    <span class="comment">// attempt.</span></div>
<div class="line"><a id="l00282" name="l00282"></a><span class="lineno">  282</span>    <span class="keywordflow">if</span> (reservation_base_ &lt;= highest_allowed_address || <a class="code hl_namespace" href="namespacev8_1_1internal.html">i</a> == kMaxAttempts)</div>
<div class="line"><a id="l00283" name="l00283"></a><span class="lineno">  283</span>      <span class="keywordflow">break</span>;</div>
<div class="line"><a id="l00284" name="l00284"></a><span class="lineno">  284</span> </div>
<div class="line"><a id="l00285" name="l00285"></a><span class="lineno">  285</span>    <span class="comment">// Can&#39;t use this base, so free the reservation and try again</span></div>
<div class="line"><a id="l00286" name="l00286"></a><span class="lineno">  286</span>    vas-&gt;FreePages(reservation_base_, size_to_reserve);</div>
<div class="line"><a id="l00287" name="l00287"></a><span class="lineno">  287</span>    reservation_base_ = <a class="code hl_variable" href="namespacev8_1_1base.html#ae714b233e65334e0104cda752fc559c5">kNullAddress</a>;</div>
<div class="line"><a id="l00288" name="l00288"></a><span class="lineno">  288</span>  }</div>
<div class="line"><a id="l00289" name="l00289"></a><span class="lineno">  289</span>  <a class="code hl_define" href="logging_8h.html#ae17f8119c108cf3070bad3449c7e0006">DCHECK</a>(reservation_base_);</div>
<div class="line"><a id="l00290" name="l00290"></a><span class="lineno">  290</span> </div>
<div class="line"><a id="l00291" name="l00291"></a><span class="lineno">  291</span>  <a class="code hl_variable" href="instruction-selector-arm64_8cc.html#a0715e37648068c3100161798fc42a972">base_</a> = reservation_base_;</div>
<div class="line"><a id="l00292" name="l00292"></a><span class="lineno">  292</span>  <a class="code hl_variable" href="codegen_2assembler_8cc.html#a50218915641ec8f39877c2565e95a604">size_</a> = <a class="code hl_variable" href="setup-heap-internal_8cc.html#a439227feff9d7f55384e8780cfc2eb82">size</a>;</div>
<div class="line"><a id="l00293" name="l00293"></a><span class="lineno">  293</span>  <a class="code hl_variable" href="cppgc_2sweeper_8cc.html#a69a1b0005c5803e98bd8cbe2ef95d570">end_</a> = <a class="code hl_variable" href="instruction-selector-arm64_8cc.html#a0715e37648068c3100161798fc42a972">base_</a> + <a class="code hl_variable" href="codegen_2assembler_8cc.html#a50218915641ec8f39877c2565e95a604">size_</a>;</div>
<div class="line"><a id="l00294" name="l00294"></a><span class="lineno">  294</span>  reservation_size_ = size_to_reserve;</div>
<div class="line"><a id="l00295" name="l00295"></a><span class="lineno">  295</span>  initialized_ = <span class="keyword">true</span>;</div>
<div class="line"><a id="l00296" name="l00296"></a><span class="lineno">  296</span>  address_space_ = std::make_unique&lt;base::EmulatedVirtualAddressSubspace&gt;(</div>
<div class="line"><a id="l00297" name="l00297"></a><span class="lineno">  297</span>      vas, reservation_base_, reservation_size_, <a class="code hl_variable" href="codegen_2assembler_8cc.html#a50218915641ec8f39877c2565e95a604">size_</a>);</div>
<div class="line"><a id="l00298" name="l00298"></a><span class="lineno">  298</span>  sandbox_page_allocator_ =</div>
<div class="line"><a id="l00299" name="l00299"></a><span class="lineno">  299</span>      std::make_unique&lt;base::VirtualAddressSpacePageAllocator&gt;(</div>
<div class="line"><a id="l00300" name="l00300"></a><span class="lineno">  300</span>          address_space_.get());</div>
<div class="line"><a id="l00301" name="l00301"></a><span class="lineno">  301</span> </div>
<div class="line"><a id="l00302" name="l00302"></a><span class="lineno">  302</span>  FinishInitialization();</div>
<div class="line"><a id="l00303" name="l00303"></a><span class="lineno">  303</span> </div>
<div class="line"><a id="l00304" name="l00304"></a><span class="lineno">  304</span>  <a class="code hl_define" href="logging_8h.html#ae17f8119c108cf3070bad3449c7e0006">DCHECK</a>(is_partially_reserved());</div>
<div class="line"><a id="l00305" name="l00305"></a><span class="lineno">  305</span>  <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line"><a id="l00306" name="l00306"></a><span class="lineno">  306</span>}</div>
<div class="line"><a id="l00307" name="l00307"></a><span class="lineno">  307</span> </div>
<div class="line"><a id="l00308" name="l00308"></a><span class="lineno">  308</span><span class="keywordtype">void</span> Sandbox::FinishInitialization() {</div>
<div class="line"><a id="l00309" name="l00309"></a><span class="lineno">  309</span>  <span class="comment">// Reserve the last page in the sandbox. This way, we can place inaccessible</span></div>
<div class="line"><a id="l00310" name="l00310"></a><span class="lineno">  310</span>  <span class="comment">// &quot;objects&quot; (e.g. the empty backing store buffer) there that are guaranteed</span></div>
<div class="line"><a id="l00311" name="l00311"></a><span class="lineno">  311</span>  <span class="comment">// to cause a fault on any accidental access.</span></div>
<div class="line"><a id="l00312" name="l00312"></a><span class="lineno">  312</span>  <span class="comment">// Further, this also prevents the accidental construction of invalid</span></div>
<div class="line"><a id="l00313" name="l00313"></a><span class="lineno">  313</span>  <span class="comment">// SandboxedPointers: if an ArrayBuffer is placed right at the end of the</span></div>
<div class="line"><a id="l00314" name="l00314"></a><span class="lineno">  314</span>  <span class="comment">// sandbox, an ArrayBufferView could be constructed with byteLength=0 and</span></div>
<div class="line"><a id="l00315" name="l00315"></a><span class="lineno">  315</span>  <span class="comment">// offset=buffer.byteLength, which would lead to a pointer that points just</span></div>
<div class="line"><a id="l00316" name="l00316"></a><span class="lineno">  316</span>  <span class="comment">// outside of the sandbox.</span></div>
<div class="line"><a id="l00317" name="l00317"></a><span class="lineno">  317</span>  <span class="keywordtype">size_t</span> allocation_granularity = address_space_-&gt;allocation_granularity();</div>
<div class="line"><a id="l00318" name="l00318"></a><span class="lineno">  318</span>  <span class="keywordtype">bool</span> success = address_space_-&gt;AllocateGuardRegion(</div>
<div class="line"><a id="l00319" name="l00319"></a><span class="lineno">  319</span>      <a class="code hl_variable" href="cppgc_2sweeper_8cc.html#a69a1b0005c5803e98bd8cbe2ef95d570">end_</a> - allocation_granularity, allocation_granularity);</div>
<div class="line"><a id="l00320" name="l00320"></a><span class="lineno">  320</span>  <span class="comment">// If the sandbox is partially-reserved, this operation may fail, for example</span></div>
<div class="line"><a id="l00321" name="l00321"></a><span class="lineno">  321</span>  <span class="comment">// if the last page is outside of the mappable address space of the process.</span></div>
<div class="line"><a id="l00322" name="l00322"></a><span class="lineno">  322</span>  <a class="code hl_define" href="logging_8h.html#a3e1cfef60e774a81f30eaddf26a3a274">CHECK</a>(success || is_partially_reserved());</div>
<div class="line"><a id="l00323" name="l00323"></a><span class="lineno">  323</span> </div>
<div class="line"><a id="l00324" name="l00324"></a><span class="lineno">  324</span>  InitializeConstants();</div>
<div class="line"><a id="l00325" name="l00325"></a><span class="lineno">  325</span>}</div>
<div class="line"><a id="l00326" name="l00326"></a><span class="lineno">  326</span> </div>
<div class="line"><a id="l00327" name="l00327"></a><span class="lineno">  327</span><span class="keywordtype">void</span> Sandbox::InitializeConstants() {</div>
<div class="line"><a id="l00328" name="l00328"></a><span class="lineno">  328</span>  <span class="comment">// Place the empty backing store buffer at the end of the sandbox, so that any</span></div>
<div class="line"><a id="l00329" name="l00329"></a><span class="lineno">  329</span>  <span class="comment">// accidental access to it will most likely hit a guard page.</span></div>
<div class="line"><a id="l00330" name="l00330"></a><span class="lineno">  330</span>  constants_.set_empty_backing_store_buffer(<a class="code hl_variable" href="cppgc_2sweeper_8cc.html#a69a1b0005c5803e98bd8cbe2ef95d570">end_</a> - 1);</div>
<div class="line"><a id="l00331" name="l00331"></a><span class="lineno">  331</span>}</div>
<div class="line"><a id="l00332" name="l00332"></a><span class="lineno">  332</span> </div>
<div class="line"><a id="l00333" name="l00333"></a><span class="lineno">  333</span><span class="keywordtype">void</span> Sandbox::TearDown() {</div>
<div class="line"><a id="l00334" name="l00334"></a><span class="lineno">  334</span>  <span class="keywordflow">if</span> (initialized_) {</div>
<div class="line"><a id="l00335" name="l00335"></a><span class="lineno">  335</span>    <span class="comment">// This destroys the sub space and frees the underlying reservation.</span></div>
<div class="line"><a id="l00336" name="l00336"></a><span class="lineno">  336</span>    address_space_.reset();</div>
<div class="line"><a id="l00337" name="l00337"></a><span class="lineno">  337</span>    sandbox_page_allocator_.reset();</div>
<div class="line"><a id="l00338" name="l00338"></a><span class="lineno">  338</span>    <a class="code hl_variable" href="instruction-selector-arm64_8cc.html#a0715e37648068c3100161798fc42a972">base_</a> = <a class="code hl_variable" href="namespacev8_1_1base.html#ae714b233e65334e0104cda752fc559c5">kNullAddress</a>;</div>
<div class="line"><a id="l00339" name="l00339"></a><span class="lineno">  339</span>    <a class="code hl_variable" href="cppgc_2sweeper_8cc.html#a69a1b0005c5803e98bd8cbe2ef95d570">end_</a> = <a class="code hl_variable" href="namespacev8_1_1base.html#ae714b233e65334e0104cda752fc559c5">kNullAddress</a>;</div>
<div class="line"><a id="l00340" name="l00340"></a><span class="lineno">  340</span>    <a class="code hl_variable" href="codegen_2assembler_8cc.html#a50218915641ec8f39877c2565e95a604">size_</a> = 0;</div>
<div class="line"><a id="l00341" name="l00341"></a><span class="lineno">  341</span>    reservation_base_ = <a class="code hl_variable" href="namespacev8_1_1base.html#ae714b233e65334e0104cda752fc559c5">kNullAddress</a>;</div>
<div class="line"><a id="l00342" name="l00342"></a><span class="lineno">  342</span>    reservation_size_ = 0;</div>
<div class="line"><a id="l00343" name="l00343"></a><span class="lineno">  343</span>    initialized_ = <span class="keyword">false</span>;</div>
<div class="line"><a id="l00344" name="l00344"></a><span class="lineno">  344</span>    constants_.Reset();</div>
<div class="line"><a id="l00345" name="l00345"></a><span class="lineno">  345</span>  }</div>
<div class="line"><a id="l00346" name="l00346"></a><span class="lineno">  346</span>}</div>
<div class="line"><a id="l00347" name="l00347"></a><span class="lineno">  347</span> </div>
<div class="line"><a id="l00348" name="l00348"></a><span class="lineno">  348</span><span class="comment">// static</span></div>
<div class="line"><a id="l00349" name="l00349"></a><span class="lineno">  349</span><span class="keywordtype">void</span> Sandbox::InitializeDefaultOncePerProcess(v8::VirtualAddressSpace* vas) {</div>
<div class="line"><a id="l00350" name="l00350"></a><span class="lineno">  350</span>  <span class="keyword">static</span> base::LeakyObject&lt;Sandbox&gt; default_sandbox;</div>
<div class="line"><a id="l00351" name="l00351"></a><span class="lineno">  351</span>  default_sandbox_ = default_sandbox.get();</div>
<div class="line"><a id="l00352" name="l00352"></a><span class="lineno">  352</span> </div>
<div class="line"><a id="l00353" name="l00353"></a><span class="lineno">  353</span><span class="preprocessor">#ifdef V8_COMPRESS_POINTERS_IN_MULTIPLE_CAGES</span></div>
<div class="line"><a id="l00354" name="l00354"></a><span class="lineno">  354</span>  set_current(default_sandbox_);</div>
<div class="line"><a id="l00355" name="l00355"></a><span class="lineno">  355</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00356" name="l00356"></a><span class="lineno">  356</span>  default_sandbox_-&gt;Initialize(vas);</div>
<div class="line"><a id="l00357" name="l00357"></a><span class="lineno">  357</span>}</div>
<div class="line"><a id="l00358" name="l00358"></a><span class="lineno">  358</span> </div>
<div class="line"><a id="l00359" name="l00359"></a><span class="lineno">  359</span><span class="comment">// static</span></div>
<div class="line"><a id="l00360" name="l00360"></a><span class="lineno">  360</span><span class="keywordtype">void</span> Sandbox::TearDownDefault() {</div>
<div class="line"><a id="l00361" name="l00361"></a><span class="lineno">  361</span>  GetDefault()-&gt;TearDown();</div>
<div class="line"><a id="l00362" name="l00362"></a><span class="lineno">  362</span> </div>
<div class="line"><a id="l00363" name="l00363"></a><span class="lineno">  363</span><span class="preprocessor">#ifdef V8_COMPRESS_POINTERS_IN_MULTIPLE_CAGES</span></div>
<div class="line"><a id="l00364" name="l00364"></a><span class="lineno">  364</span>  set_current(<span class="keyword">nullptr</span>);</div>
<div class="line"><a id="l00365" name="l00365"></a><span class="lineno">  365</span><span class="preprocessor">#endif</span></div>
<div class="line"><a id="l00366" name="l00366"></a><span class="lineno">  366</span>}</div>
<div class="line"><a id="l00367" name="l00367"></a><span class="lineno">  367</span> </div>
<div class="line"><a id="l00368" name="l00368"></a><span class="lineno">  368</span><span class="comment">// static</span></div>
<div class="line"><a id="l00369" name="l00369"></a><span class="lineno">  369</span>Sandbox* Sandbox::New(v8::VirtualAddressSpace* vas) {</div>
<div class="line"><a id="l00370" name="l00370"></a><span class="lineno">  370</span>  <span class="keywordflow">if</span> (!<a class="code hl_define" href="common_2globals_8h.html#a58549a1ae1607e26af5c25dbca14aaf1">COMPRESS_POINTERS_IN_MULTIPLE_CAGES_BOOL</a>) {</div>
<div class="line"><a id="l00371" name="l00371"></a><span class="lineno">  371</span>    <a class="code hl_define" href="logging_8h.html#a0d093cb749cfc7ab5993726392df681f">FATAL</a>(</div>
<div class="line"><a id="l00372" name="l00372"></a><span class="lineno">  372</span>        <span class="stringliteral">&quot;Creation of new sandboxes requires enabling &quot;</span></div>
<div class="line"><a id="l00373" name="l00373"></a><span class="lineno">  373</span>        <span class="stringliteral">&quot;multiple pointer compression cages at build-time&quot;</span>);</div>
<div class="line"><a id="l00374" name="l00374"></a><span class="lineno">  374</span>  }</div>
<div class="line"><a id="l00375" name="l00375"></a><span class="lineno">  375</span>  Sandbox* sandbox = <span class="keyword">new</span> Sandbox;</div>
<div class="line"><a id="l00376" name="l00376"></a><span class="lineno">  376</span>  sandbox-&gt;Initialize(vas);</div>
<div class="line"><a id="l00377" name="l00377"></a><span class="lineno">  377</span>  <a class="code hl_define" href="logging_8h.html#a3e1cfef60e774a81f30eaddf26a3a274">CHECK</a>(!<a class="code hl_variable" href="namespacev8_1_1internal.html#aa9db791c05a0359859a321dcfec42e37">v8_flags</a>.sandbox_testing &amp;&amp; !<a class="code hl_variable" href="namespacev8_1_1internal.html#aa9db791c05a0359859a321dcfec42e37">v8_flags</a>.sandbox_fuzzing);</div>
<div class="line"><a id="l00378" name="l00378"></a><span class="lineno">  378</span>  <span class="keywordflow">return</span> sandbox;</div>
<div class="line"><a id="l00379" name="l00379"></a><span class="lineno">  379</span>}</div>
<div class="line"><a id="l00380" name="l00380"></a><span class="lineno">  380</span> </div>
<div class="line"><a id="l00381" name="l00381"></a><span class="lineno">  381</span><span class="preprocessor">#endif  </span><span class="comment">// V8_ENABLE_SANDBOX</span></div>
<div class="line"><a id="l00382" name="l00382"></a><span class="lineno">  382</span> </div>
<div class="line"><a id="l00383" name="l00383"></a><span class="lineno">  383</span>}  <span class="comment">// namespace internal</span></div>
<div class="line"><a id="l00384" name="l00384"></a><span class="lineno">  384</span>}  <span class="comment">// namespace v8</span></div>
<div class="ttc" id="aallocation_8h_html"><div class="ttname"><a href="allocation_8h.html">allocation.h</a></div></div>
<div class="ttc" id="abits_8h_html"><div class="ttname"><a href="bits_8h.html">bits.h</a></div></div>
<div class="ttc" id="abounded-page-allocator_8h_html"><div class="ttname"><a href="bounded-page-allocator_8h.html">bounded-page-allocator.h</a></div></div>
<div class="ttc" id="aclassv8_1_1base_1_1SysInfo_html_a5bfbc11d20bf73ed9cb8986c17d0ee4e"><div class="ttname"><a href="classv8_1_1base_1_1SysInfo.html#a5bfbc11d20bf73ed9cb8986c17d0ee4e">v8::base::SysInfo::AddressSpaceEnd</a></div><div class="ttdeci">static uintptr_t AddressSpaceEnd()</div><div class="ttdef"><b>Definition</b> <a href="sys-info_8cc_source.html#l00136">sys-info.cc:136</a></div></div>
<div class="ttc" id="aclassv8_1_1internal_1_1SandboxHardwareSupport_html_a71342ee373995ec74a61e8a3f0a08d4b"><div class="ttname"><a href="classv8_1_1internal_1_1SandboxHardwareSupport.html#a71342ee373995ec74a61e8a3f0a08d4b">v8::internal::SandboxHardwareSupport::TryEnable</a></div><div class="ttdeci">static bool TryEnable(Address addr, size_t size)</div><div class="ttdef"><b>Definition</b> <a href="hardware-support_8cc_source.html#l00077">hardware-support.cc:77</a></div></div>
<div class="ttc" id="aclassv8_1_1internal_1_1V8_html_a977b087d4ee58955efe72b33136a4e94"><div class="ttname"><a href="classv8_1_1internal_1_1V8.html#a977b087d4ee58955efe72b33136a4e94">v8::internal::V8::FatalProcessOutOfMemory</a></div><div class="ttdeci">static V8_EXPORT_PRIVATE void FatalProcessOutOfMemory(Isolate *isolate, const char *location, const OOMDetails &amp;details=kNoOOMDetails)</div></div>
<div class="ttc" id="acodegen_2assembler_8cc_html_a50218915641ec8f39877c2565e95a604"><div class="ttname"><a href="codegen_2assembler_8cc.html#a50218915641ec8f39877c2565e95a604">size_</a></div><div class="ttdeci">const int size_</div><div class="ttdef"><b>Definition</b> <a href="codegen_2assembler_8cc_source.html#l00132">assembler.cc:132</a></div></div>
<div class="ttc" id="acommon_2globals_8h_html_a58549a1ae1607e26af5c25dbca14aaf1"><div class="ttname"><a href="common_2globals_8h.html#a58549a1ae1607e26af5c25dbca14aaf1">COMPRESS_POINTERS_IN_MULTIPLE_CAGES_BOOL</a></div><div class="ttdeci">#define COMPRESS_POINTERS_IN_MULTIPLE_CAGES_BOOL</div><div class="ttdef"><b>Definition</b> <a href="common_2globals_8h_source.html#l00117">globals.h:117</a></div></div>
<div class="ttc" id="acppgc_2sweeper_8cc_html_a69a1b0005c5803e98bd8cbe2ef95d570"><div class="ttname"><a href="cppgc_2sweeper_8cc.html#a69a1b0005c5803e98bd8cbe2ef95d570">end_</a></div><div class="ttdeci">const v8::base::TimeTicks end_</div><div class="ttdef"><b>Definition</b> <a href="cppgc_2sweeper_8cc_source.html#l00054">sweeper.cc:54</a></div></div>
<div class="ttc" id="acpu_8h_html"><div class="ttname"><a href="cpu_8h.html">cpu.h</a></div></div>
<div class="ttc" id="adebug-coverage_8cc_html_a37722a150250e2a5a98e5e0d11e53449"><div class="ttname"><a href="debug-coverage_8cc.html#a37722a150250e2a5a98e5e0d11e53449">start</a></div><div class="ttdeci">int start</div><div class="ttdef"><b>Definition</b> <a href="debug-coverage_8cc_source.html#l00595">debug-coverage.cc:595</a></div></div>
<div class="ttc" id="adebug-coverage_8cc_html_abce9f5dc9c83f2639b72024fdee5d388"><div class="ttname"><a href="debug-coverage_8cc.html#abce9f5dc9c83f2639b72024fdee5d388">end</a></div><div class="ttdeci">int end</div><div class="ttdef"><b>Definition</b> <a href="debug-coverage_8cc_source.html#l00596">debug-coverage.cc:596</a></div></div>
<div class="ttc" id="aemulated-virtual-address-subspace_8h_html"><div class="ttname"><a href="emulated-virtual-address-subspace_8h.html">emulated-virtual-address-subspace.h</a></div></div>
<div class="ttc" id="aflags_2flags_8h_html"><div class="ttname"><a href="flags_2flags_8h.html">flags.h</a></div></div>
<div class="ttc" id="ahardware-support_8h_html"><div class="ttname"><a href="hardware-support_8h.html">hardware-support.h</a></div></div>
<div class="ttc" id="ainstruction-selector-arm64_8cc_html_a0715e37648068c3100161798fc42a972"><div class="ttname"><a href="instruction-selector-arm64_8cc.html#a0715e37648068c3100161798fc42a972">base_</a></div><div class="ttdeci">Adapter::node_t base_</div><div class="ttdef"><b>Definition</b> <a href="instruction-selector-arm64_8cc_source.html#l00342">instruction-selector-arm64.cc:342</a></div></div>
<div class="ttc" id="ainstruction-selector-ia32_8cc_html_a115c48491bb37004f5ac67eb46ac2c23"><div class="ttname"><a href="instruction-selector-ia32_8cc.html#a115c48491bb37004f5ac67eb46ac2c23">base</a></div><div class="ttdeci">turboshaft::OpIndex base</div><div class="ttdef"><b>Definition</b> <a href="instruction-selector-ia32_8cc_source.html#l00070">instruction-selector-ia32.cc:70</a></div></div>
<div class="ttc" id="alazy-instance_8h_html"><div class="ttname"><a href="lazy-instance_8h.html">lazy-instance.h</a></div></div>
<div class="ttc" id="alogging_8h_html_a0d093cb749cfc7ab5993726392df681f"><div class="ttname"><a href="logging_8h.html#a0d093cb749cfc7ab5993726392df681f">FATAL</a></div><div class="ttdeci">#define FATAL(...)</div><div class="ttdef"><b>Definition</b> <a href="logging_8h_source.html#l00047">logging.h:47</a></div></div>
<div class="ttc" id="alogging_8h_html_a3e1cfef60e774a81f30eaddf26a3a274"><div class="ttname"><a href="logging_8h.html#a3e1cfef60e774a81f30eaddf26a3a274">CHECK</a></div><div class="ttdeci">#define CHECK(condition)</div><div class="ttdef"><b>Definition</b> <a href="logging_8h_source.html#l00124">logging.h:124</a></div></div>
<div class="ttc" id="alogging_8h_html_a45a0717f39b7011dc823c1fe7b83e6fc"><div class="ttname"><a href="logging_8h.html#a45a0717f39b7011dc823c1fe7b83e6fc">CHECK_LT</a></div><div class="ttdeci">#define CHECK_LT(lhs, rhs)</div></div>
<div class="ttc" id="alogging_8h_html_aabec5c3b7a8628298a25f044dcf89c25"><div class="ttname"><a href="logging_8h.html#aabec5c3b7a8628298a25f044dcf89c25">DCHECK_GE</a></div><div class="ttdeci">#define DCHECK_GE(v1, v2)</div><div class="ttdef"><b>Definition</b> <a href="logging_8h_source.html#l00488">logging.h:488</a></div></div>
<div class="ttc" id="alogging_8h_html_ae17f8119c108cf3070bad3449c7e0006"><div class="ttname"><a href="logging_8h.html#ae17f8119c108cf3070bad3449c7e0006">DCHECK</a></div><div class="ttdeci">#define DCHECK(condition)</div><div class="ttdef"><b>Definition</b> <a href="logging_8h_source.html#l00482">logging.h:482</a></div></div>
<div class="ttc" id="alogging_8h_html_af9c313d74155f7f201955a939e24c71f"><div class="ttname"><a href="logging_8h.html#af9c313d74155f7f201955a939e24c71f">DCHECK_EQ</a></div><div class="ttdeci">#define DCHECK_EQ(v1, v2)</div><div class="ttdef"><b>Definition</b> <a href="logging_8h_source.html#l00485">logging.h:485</a></div></div>
<div class="ttc" id="amacros_8h_html_aa0de4a420e74c8df8076fc2aaf4af27a"><div class="ttname"><a href="macros_8h.html#aa0de4a420e74c8df8076fc2aaf4af27a">RoundDown</a></div><div class="ttdeci">constexpr T RoundDown(T x, intptr_t m)</div><div class="ttdef"><b>Definition</b> <a href="macros_8h_source.html#l00359">macros.h:359</a></div></div>
<div class="ttc" id="anamespacev8_1_1base_1_1bits_html_a05e2bc2d432bf561a7cf3ced275a87be"><div class="ttname"><a href="namespacev8_1_1base_1_1bits.html#a05e2bc2d432bf561a7cf3ced275a87be">v8::base::bits::CountLeadingZeros</a></div><div class="ttdeci">constexpr unsigned CountLeadingZeros(T value)</div><div class="ttdef"><b>Definition</b> <a href="bits_8h_source.html#l00100">bits.h:100</a></div></div>
<div class="ttc" id="anamespacev8_1_1base_1_1bits_html_a4d06086712ebcd60838caae1a21fcfa3"><div class="ttname"><a href="namespacev8_1_1base_1_1bits.html#a4d06086712ebcd60838caae1a21fcfa3">v8::base::bits::IsPowerOfTwo</a></div><div class="ttdeci">constexpr bool IsPowerOfTwo(T value)</div><div class="ttdef"><b>Definition</b> <a href="bits_8h_source.html#l00187">bits.h:187</a></div></div>
<div class="ttc" id="anamespacev8_1_1base_html_ae714b233e65334e0104cda752fc559c5"><div class="ttname"><a href="namespacev8_1_1base.html#ae714b233e65334e0104cda752fc559c5">v8::base::kNullAddress</a></div><div class="ttdeci">constexpr Address kNullAddress</div><div class="ttdef"><b>Definition</b> <a href="virtual-address-space_8h_source.html#l00018">virtual-address-space.h:18</a></div></div>
<div class="ttc" id="anamespacev8_1_1internal_1_1trap__handler_html_a3ab5bab37e5ef18e3204bfc48aa1ada0"><div class="ttname"><a href="namespacev8_1_1internal_1_1trap__handler.html#a3ab5bab37e5ef18e3204bfc48aa1ada0">v8::internal::trap_handler::SetV8SandboxBaseAndSize</a></div><div class="ttdeci">void SetV8SandboxBaseAndSize(uintptr_t base, size_t size)</div><div class="ttdef"><b>Definition</b> <a href="handler-outside_8cc_source.html#l00234">handler-outside.cc:234</a></div></div>
<div class="ttc" id="anamespacev8_1_1internal_html"><div class="ttname"><a href="namespacev8_1_1internal.html">v8::internal</a></div><div class="ttdef"><b>Definition</b> <a href="api-arguments-inl_8h_source.html#l00018">api-arguments-inl.h:18</a></div></div>
<div class="ttc" id="anamespacev8_1_1internal_html_a08e1140ec7d96bfd4d6b21a808ccd654"><div class="ttname"><a href="namespacev8_1_1internal.html#a08e1140ec7d96bfd4d6b21a808ccd654">v8::internal::MB</a></div><div class="ttdeci">too high values may cause the compiler to set high thresholds for inlining to as much as possible avoid inlined allocation of objects that cannot escape trace load stores from virtual maglev objects use TurboFan fast string builder analyze liveness of environment slots and zap dead values trace TurboFan load elimination emit data about basic block usage in builtins to this enable builtin reordering when run mksnapshot flag for emit warnings when applying builtin profile data verify register allocation in TurboFan randomly schedule instructions to stress dependency tracking enable store store elimination in TurboFan rewrite far to near simulate GC compiler thread race related to allow float parameters to be passed in simulator mode JS Wasm Run additional turbo_optimize_inlined_js_wasm_wrappers enable experimental feedback collection in generic lowering enable Turboshaft s WasmLoadElimination run instruction selection on Turboshaft IR directly enable Turboshaft s loop unrolling enable an additional Turboshaft phase that performs optimizations based on type information build the Turboshaft graph from Maglev trace emitted Turboshaft instructions profile guided optimization for empty feedback vector invocation count for maglev for functions which according to profile_guided_optimization are likely to deoptimize before reaching this invocation count Immediately re optimize code after some lazy deopts Enables the lazy new space shrinking strategy max size of a semi the new space consists of two semi spaces young and full garbage collection phases are not overlapping Collect garbage after keeps maps alive for&lt; n &gt; old space garbage collections print one detailed trace line in allocation gc speed Starts incremental marking with kUserVisible priority threshold for starting incremental marking immediately in percent of available minor GC task trigger in percent of the current heap limit use a separate phase for stack scanning in scavenge max worker number of concurrent for NumberOfWorkerThreads start background threads that allocate memory concurrent_array_buffer_sweeping use parallel threads to clear weak refs in the atomic pause trace progress of the incremental marking trace object counts and memory usage * MB</div><div class="ttdef"><b>Definition</b> <a href="flags_8cc_source.html#l02095">flags.cc:2095</a></div></div>
<div class="ttc" id="anamespacev8_1_1internal_html_a5031451934208565c827c86d9eb86c5a"><div class="ttname"><a href="namespacev8_1_1internal.html#a5031451934208565c827c86d9eb86c5a">v8::internal::internal</a></div><div class="ttdeci">internal</div><div class="ttdef"><b>Definition</b> <a href="wasm-objects-inl_8h_source.html#l00457">wasm-objects-inl.h:457</a></div></div>
<div class="ttc" id="anamespacev8_1_1internal_html_a782acb70e9eabcd3faaccfb6a3bde48e"><div class="ttname"><a href="namespacev8_1_1internal.html#a782acb70e9eabcd3faaccfb6a3bde48e">v8::internal::Address</a></div><div class="ttdeci">Address</div><div class="ttdef"><b>Definition</b> <a href="api-callbacks-inl_8h_source.html#l00034">api-callbacks-inl.h:34</a></div></div>
<div class="ttc" id="anamespacev8_1_1internal_html_aa9db791c05a0359859a321dcfec42e37"><div class="ttname"><a href="namespacev8_1_1internal.html#aa9db791c05a0359859a321dcfec42e37">v8::internal::v8_flags</a></div><div class="ttdeci">V8_EXPORT_PRIVATE FlagValues v8_flags</div></div>
<div class="ttc" id="anamespacev8_html"><div class="ttname"><a href="namespacev8.html">v8</a></div><div class="ttdef"><b>Definition</b> <a href="api-arguments-inl_8h_source.html#l00017">api-arguments-inl.h:17</a></div></div>
<div class="ttc" id="arandom-number-generator_8h_html"><div class="ttname"><a href="random-number-generator_8h.html">random-number-generator.h</a></div></div>
<div class="ttc" id="aregexp-parser_8cc_html_a2e1b080512a5c5e0ce8f64ded8138eac"><div class="ttname"><a href="regexp-parser_8cc.html#a2e1b080512a5c5e0ce8f64ded8138eac">current_</a></div><div class="ttdeci">base::uc32 current_</div><div class="ttdef"><b>Definition</b> <a href="regexp-parser_8cc_source.html#l00642">regexp-parser.cc:642</a></div></div>
<div class="ttc" id="asandbox_8h_html"><div class="ttname"><a href="sandbox_8h.html">sandbox.h</a></div></div>
<div class="ttc" id="asandboxed-pointer_8h_html"><div class="ttname"><a href="sandboxed-pointer_8h.html">sandboxed-pointer.h</a></div></div>
<div class="ttc" id="asetup-heap-internal_8cc_html_a439227feff9d7f55384e8780cfc2eb82"><div class="ttname"><a href="setup-heap-internal_8cc.html#a439227feff9d7f55384e8780cfc2eb82">size</a></div><div class="ttdeci">int size</div><div class="ttdef"><b>Definition</b> <a href="setup-heap-internal_8cc_source.html#l00126">setup-heap-internal.cc:126</a></div></div>
<div class="ttc" id="asys-info_8h_html"><div class="ttname"><a href="sys-info_8h.html">sys-info.h</a></div></div>
<div class="ttc" id="atrap-handler_8h_html"><div class="ttname"><a href="trap-handler_8h.html">trap-handler.h</a></div></div>
<div class="ttc" id="avirtual-address-space-page-allocator_8h_html"><div class="ttname"><a href="virtual-address-space-page-allocator_8h.html">virtual-address-space-page-allocator.h</a></div></div>
<div class="ttc" id="avirtual-address-space_8h_html"><div class="ttname"><a href="virtual-address-space_8h.html">virtual-address-space.h</a></div></div>
</div><!-- fragment --></div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated on Thu Apr 3 2025 08:19:59 for v8 by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.12.0
</small></address>
</div><!-- doc-content -->
</body>
</html>
